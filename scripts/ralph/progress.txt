# Ralph Progress Log
Started: Thu Jan 15 09:23:26 MST 2026
---

## Codebase Patterns
- Schema migrations are in MailDatabase.swift using versioned migration functions (applyMigrationV1, applyMigrationV2, etc.)
- Enums for database-backed values use String raw values and are defined at the bottom of MailDatabase.swift
- MailMessage struct properties must be updated when adding new DB columns
- Both upsertMessage() and batchUpsertMessages() need to be updated when adding new columns
- rowToMessage() needs column index updates when adding new columns (indexes are positional)
- Tests for database functionality are in Tests/SwiftEAKitTests/MailDatabaseTests.swift
- libsql has threading issues in tests - some tests may fail due to infrastructure, not code
- AppleScriptServiceProtocol enables mock testing - use MockAppleScriptService in tests
- Final classes need protocols for dependency injection/mockability

---

## 2026-01-15 09:24 - US-001
- **What was implemented**: Schema migration V2 for mailbox status tracking (already existed in codebase)
- **Files reviewed**:
  - Sources/SwiftEAKit/Modules/MailModule/MailDatabase.swift
  - Tests/SwiftEAKitTests/MailDatabaseTests.swift
- **Implementation details**:
  - applyMigrationV2() adds: mailbox_status (TEXT, default 'inbox'), pending_sync_action (TEXT), last_known_mailbox_id (INTEGER)
  - MailboxStatus enum: .inbox, .archived, .deleted
  - SyncAction enum: .archive, .delete
  - MailMessage struct updated with mailboxStatus, pendingSyncAction, lastKnownMailboxId properties
  - upsertMessage() and batchUpsertMessages() handle the new columns
  - rowToMessage() parses columns at indexes 21 (mailbox_status), 22 (pending_sync_action), 23 (last_known_mailbox_id)
- **Status**: ALREADY COMPLETE - US-001 was implemented in a prior commit (3584cd2)
- **Learnings for future iterations**:
  - Check git history before assuming features need implementation
  - Column indexes in rowToMessage() are positional and must match SELECT * order
  - Migration V2 already creates indexes for mailbox_status and pending_sync_action
---

## 2026-01-15 09:26 - US-002
- **What was implemented**: Database methods for mailbox status queries and updates
- **Files changed**:
  - Sources/SwiftEAKit/Modules/MailModule/MailDatabase.swift (added 6 new methods)
  - Tests/SwiftEAKitTests/MailDatabaseTests.swift (added 20 new tests)
- **Implementation details**:
  - updateMailboxStatus(id:status:) - Updates mailbox_status column
  - setPendingSyncAction(id:action:) - Sets pending_sync_action to archive or delete
  - clearPendingSyncAction(id:) - Sets pending_sync_action to NULL
  - getMessagesWithPendingActions() - Returns messages with non-null pending_sync_action
  - getMessagesByStatus(_:limit:offset:) - Filters by mailbox_status with pagination
  - getMessageCountByStatus() - Returns [MailboxStatus: Int] dictionary
- **All methods**:
  - Handle missing message IDs gracefully (no-op for updates, empty for queries)
  - Exclude soft-deleted messages (is_deleted = 1)
- **Tests**: 20 new tests covering all methods + edge cases + error handling
- **Learnings for future iterations**:
  - Use ORDER BY updated_at ASC for pending actions (oldest first = fairness)
  - Use ORDER BY date_received DESC for message lists (newest first = user expectation)
  - Initialize counts dictionary with 0 values to handle missing status groups
---

## 2026-01-15 09:30 - US-003
- **What was implemented**: Filter initial sync to INBOX messages only
- **Files changed**:
  - Sources/SwiftEAKit/Modules/MailModule/MailSync.swift (added MailboxType enum, classifyMailbox function, updated queryMessages)
  - Tests/SwiftEAKitTests/MailSyncTests.swift (added 10 new tests)
- **Implementation details**:
  - Added MailboxType enum with cases: inbox, archive, trash, sent, drafts, junk, other
  - Added classifyMailbox(url:name:) function that classifies mailboxes from URL or name
  - Classification is case-insensitive (e.g., "INBOX", "inbox", "Inbox" all return .inbox)
  - Updated queryMessages() to INNER JOIN with mailboxes table and filter WHERE LOWER(mb.url) LIKE '%/inbox'
  - New synced messages get mailbox_status = 'inbox' by default (MailMessage init default)
- **Tests added**: 10 new tests for MailboxType enum values and classifyMailbox function
- **Learnings for future iterations**:
  - Apple Mail URLs end with the mailbox name (e.g., "mailbox://account/INBOX")
  - Use LOWER() in SQL for case-insensitive matching
  - Use INNER JOIN (not LEFT JOIN) when filtering to only include rows with matches
---

## 2026-01-15 09:35 - US-004
- **What was implemented**: Detect mailbox moves in Apple Mail (forward sync)
- **Files changed**:
  - Sources/SwiftEAKit/Modules/MailModule/MailSync.swift (added detectMailboxMoves() function, integrated into incremental sync)
  - Sources/SwiftEAKit/Modules/MailModule/MailDatabase.swift (updated getTrackedInboxMessages() to track all statuses)
  - Tests/SwiftEAKitTests/MailSyncTests.swift (added 12 new tests for mailbox move detection)
- **Implementation details**:
  - Added public detectMailboxMoves() function to MailSync class
  - Function queries Apple Mail database for current mailbox of all tracked messages
  - Uses classifyMailbox() to determine mailbox type (inbox, archive, trash, etc.)
  - Updates mailbox_status based on detected moves:
    - Messages in Archive folder → status = 'archived'
    - Messages in Trash folder → status = 'deleted'
    - Messages in INBOX → status = 'inbox' (Apple Mail wins - allows move-back)
  - Batched queries (500 messages per batch) for performance
  - Integrated into performIncrementalSync() as Phase 3 (before deletion detection)
  - Returns count of status changes
- **getTrackedInboxMessages() update**:
  - Changed from only returning inbox messages to returning ALL non-soft-deleted messages
  - This enables detection when archived/deleted messages move back to INBOX
- **Tests added**: 12 new tests covering:
  - getTrackedInboxMessages includes all statuses (inbox, archived, deleted)
  - getTrackedInboxMessages excludes soft-deleted messages
  - TrackedMessageInfo contains correct data
  - updateMailboxStatus works for inbox→archived, archived→inbox, inbox→deleted transitions
- **Learnings for future iterations**:
  - getTrackedInboxMessages must return ALL messages (not just inbox) to detect move-back scenarios
  - Apple Mail is the source of truth for forward sync - always update local status to match
  - Use batch size of 500 for efficient Apple Mail DB queries
  - NULL vs 0 in database: appleRowId=nil is stored as 0, not NULL, so queries should use IS NOT NULL
---

## 2026-01-15 09:38 - US-005
- **What was implemented**: Push archive/delete actions to Apple Mail (backward sync)
- **Files changed**:
  - Sources/SwiftEAKit/Modules/MailModule/MailSyncBackward.swift (NEW FILE - 260 lines)
- **Implementation details**:
  - Created MailSyncBackward class with mailDatabase and appleScriptService dependencies
  - archiveMessage(id:) method using optimistic update pattern:
    1. Get current message state for rollback
    2. Update local DB: mailbox_status='archived', pending_sync_action='archive'
    3. Execute AppleScript to move to Archive mailbox
    4. On success: clear pending_sync_action
    5. On failure: rollback to original status and clear pending action
  - deleteMessage(id:) method with same optimistic update pattern for Trash
  - processPendingActions() method that processes all queued actions (for daemon sync)
  - BackwardSyncResult struct with archived, deleted, failed counts and errors array
  - BackwardSyncError enum: messageNotFound, noMessageId, appleScriptFailed, rollbackFailed
  - MailSyncBackwardScripts struct with AppleScript templates for archive/delete
- **AppleScript implementation**:
  - archiveMessage: finds message by RFC822 Message-ID, moves to account's Archive mailbox
  - deleteMessage: finds message by RFC822 Message-ID, uses Mail.app delete command (moves to Trash)
  - Both scripts include error handling for message not found (-1728)
- **Key design decisions**:
  - Uses RFC822 Message-ID (not SwiftEA ID) for AppleScript lookup
  - Optimistic update ensures local DB reflects intent immediately
  - Rollback on failure prevents desync between local state and Apple Mail
  - processPendingActions() doesn't clear pending action on failure (will retry next sync)
- **Learnings for future iterations**:
  - AppleScript uses "message id" property which is the RFC822 Message-ID
  - Account's Archive mailbox is accessed via: mailbox "Archive" of theAccount
  - Mail.app delete command automatically moves to account's Trash
  - Always validate message exists and has RFC822 Message-ID before AppleScript
---

## 2026-01-15 09:43 - US-006
- **What was implemented**: Update daemon to 60-second interval with backward sync
- **Files changed**:
  - Sources/SwiftEACLI/Commands/MailCommand.swift (updated default interval, added backward sync integration)
- **Implementation details**:
  - Changed defaultIntervalSeconds from 300 to 60 (5 minutes → 1 minute)
  - Added MailSyncBackward instance to MailSyncDaemonController class
  - Added performBackwardSync() method to MailSyncCommand for manual sync
  - Added performBackwardSync() method to MailSyncDaemonController for daemon sync
  - Added performDaemonBackwardSync() function for daemon startup
  - Integrated backward sync after forward sync in:
    - executeSync() - manual 'swea mail sync' command
    - performSync() - MailSyncDaemonController scheduled/wake syncs
    - performDaemonSync() - daemon startup initial sync
  - Logging for backward sync results:
    - Success: "Backward sync: X archived, Y deleted"
    - Warnings: "WARNING: Backward sync failed for N message(s)" with error details
- **Learnings for future iterations**:
  - Backward sync should be called after forward sync to process any queued actions
  - Failed backward sync should not fail the overall sync (log warning, continue)
  - Default interval comments should match the actual value (was "5 minutes" with 60)
---

## 2026-01-15 09:47 - US-007
- **What was implemented**: Update CLI archive/delete commands to use backward sync with --status search filter
- **Files changed**:
  - Sources/SwiftEACLI/Commands/MailCommand.swift (updated MailArchiveCommand, MailDeleteCommand, MailSearchCommand)
  - Sources/SwiftEAKit/Modules/MailModule/MailDatabase.swift (added mailboxStatus to SearchFilter)
- **Implementation details**:
  - **MailArchiveCommand**: Now uses MailSyncBackward.archiveMessage() instead of raw AppleScript
    - Removed inline AppleScript and escapeAppleScript helper
    - Creates MailSyncBackward instance and calls archiveMessage(id:)
    - Benefits: optimistic update pattern with automatic rollback on failure
  - **MailDeleteCommand**: Now uses MailSyncBackward.deleteMessage() instead of raw AppleScript
    - Removed MailActionScripts.deleteMessage() call
    - Creates MailSyncBackward instance and calls deleteMessage(id:)
    - Benefits: consistent behavior with archive, proper status tracking
  - **MailSearchCommand --status option**:
    - Added @Option status: String? to parse --status flag
    - Added validation for valid status values (inbox, archived, deleted)
    - Added MailValidationError.invalidStatus(value:) with helpful error message
    - Applied status filter to SearchFilter.mailboxStatus in run()
    - Updated filter summary display to show status when filtered
    - Updated help text with STATUS FILTER section and examples
  - **SearchFilter.mailboxStatus**: Added mailboxStatus: MailboxStatus? property
    - Updated hasFilters computed property to include mailboxStatus
    - Added WHERE clause in searchMessagesWithFilters() for mailbox_status column
- **Tests**: Build and validation tests pass; database tests have known libsql threading issue
- **Learnings for future iterations**:
  - Use MailSyncBackward for all archive/delete operations to ensure consistent state tracking
  - SearchFilter is mutable (var) when applying CLI options after parseQuery()
  - Validation errors should provide helpful message with valid options list
---

## 2026-01-15 09:53 - US-008
- **What was implemented**: Automated test suite for bidirectional sync functionality
- **Files changed**:
  - Tests/SwiftEAKitTests/MailSyncBackwardTests.swift (NEW FILE - 707 lines, 35 tests)
  - Sources/SwiftEAKit/Modules/MailModule/AppleScriptService.swift (added AppleScriptServiceProtocol)
  - Sources/SwiftEAKit/Modules/MailModule/MailSyncBackward.swift (updated to use protocol)
- **Implementation details**:
  - Created AppleScriptServiceProtocol for dependency injection and testability
  - AppleScriptService now conforms to AppleScriptServiceProtocol
  - MailSyncBackward now accepts AppleScriptServiceProtocol for mockable testing
  - MockAppleScriptService class for test mocking:
    - Records executeMailScript calls for verification
    - Configurable success/failure via shouldFail flag
    - Supports capturing state during execution via onExecute callback
  - 35 comprehensive tests covering:
    - BackwardSyncResult initialization and defaults
    - BackwardSyncError messages for all error cases
    - archiveMessage: not found, no message ID, optimistic update before AppleScript, success/failure/rollback
    - deleteMessage: same test coverage as archiveMessage
    - processPendingActions: empty, archive/delete/mixed actions, skip no-message-id, failed actions retained
    - MailSyncBackwardScripts: message ID inclusion, special character escaping, error handling
    - Integration tests: full archive/delete workflows, pending action reprocessing
  - **Key test**: testArchiveMessageOptimisticUpdateSetsStatusBeforeAppleScript
    - Uses CapturingMockAppleScript to capture DB state during AppleScript execution
    - Verifies status is already 'archived' and pendingSyncAction is 'archive' before AppleScript runs
  - **Key test**: testArchiveMessageFailureRollsBack
    - Verifies that on AppleScript failure, status is rolled back to original value
    - Verifies pending action is cleared (not left in inconsistent state)
- **Existing test coverage** (already in place from prior stories):
  - MailDatabaseTests.swift: V2 migration tests (mailbox_status, pending_sync_action, last_known_mailbox_id)
  - MailSyncTests.swift: classifyMailbox tests, updateMailboxStatus tests, getMessagesByStatus tests
- **Test results**: 212 Mail-related tests pass (35 new MailSyncBackwardTests + existing)
- **Learnings for future iterations**:
  - Use protocols for dependency injection when testing AppleScript-dependent code
  - MockAppleScriptService pattern allows capturing state during mock execution
  - @unchecked Sendable is needed for mock classes with mutable state
  - Final classes can't be subclassed - use protocols for mockability
---
