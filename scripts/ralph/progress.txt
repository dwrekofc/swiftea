# Ralph Progress Log
Started: Thu Jan 15 09:23:26 MST 2026
---

## Codebase Patterns
- Schema migrations are in MailDatabase.swift using versioned migration functions (applyMigrationV1, applyMigrationV2, etc.)
- Enums for database-backed values use String raw values and are defined at the bottom of MailDatabase.swift
- MailMessage struct properties must be updated when adding new DB columns
- Both upsertMessage() and batchUpsertMessages() need to be updated when adding new columns
- rowToMessage() needs column index updates when adding new columns (indexes are positional)
- Tests for database functionality are in Tests/SwiftEAKitTests/MailDatabaseTests.swift
- libsql has threading issues in tests - some tests may fail due to infrastructure, not code

---

## 2026-01-15 09:24 - US-001
- **What was implemented**: Schema migration V2 for mailbox status tracking (already existed in codebase)
- **Files reviewed**:
  - Sources/SwiftEAKit/Modules/MailModule/MailDatabase.swift
  - Tests/SwiftEAKitTests/MailDatabaseTests.swift
- **Implementation details**:
  - applyMigrationV2() adds: mailbox_status (TEXT, default 'inbox'), pending_sync_action (TEXT), last_known_mailbox_id (INTEGER)
  - MailboxStatus enum: .inbox, .archived, .deleted
  - SyncAction enum: .archive, .delete
  - MailMessage struct updated with mailboxStatus, pendingSyncAction, lastKnownMailboxId properties
  - upsertMessage() and batchUpsertMessages() handle the new columns
  - rowToMessage() parses columns at indexes 21 (mailbox_status), 22 (pending_sync_action), 23 (last_known_mailbox_id)
- **Status**: ALREADY COMPLETE - US-001 was implemented in a prior commit (3584cd2)
- **Learnings for future iterations**:
  - Check git history before assuming features need implementation
  - Column indexes in rowToMessage() are positional and must match SELECT * order
  - Migration V2 already creates indexes for mailbox_status and pending_sync_action
---

## 2026-01-15 09:26 - US-002
- **What was implemented**: Database methods for mailbox status queries and updates
- **Files changed**:
  - Sources/SwiftEAKit/Modules/MailModule/MailDatabase.swift (added 6 new methods)
  - Tests/SwiftEAKitTests/MailDatabaseTests.swift (added 20 new tests)
- **Implementation details**:
  - updateMailboxStatus(id:status:) - Updates mailbox_status column
  - setPendingSyncAction(id:action:) - Sets pending_sync_action to archive or delete
  - clearPendingSyncAction(id:) - Sets pending_sync_action to NULL
  - getMessagesWithPendingActions() - Returns messages with non-null pending_sync_action
  - getMessagesByStatus(_:limit:offset:) - Filters by mailbox_status with pagination
  - getMessageCountByStatus() - Returns [MailboxStatus: Int] dictionary
- **All methods**:
  - Handle missing message IDs gracefully (no-op for updates, empty for queries)
  - Exclude soft-deleted messages (is_deleted = 1)
- **Tests**: 20 new tests covering all methods + edge cases + error handling
- **Learnings for future iterations**:
  - Use ORDER BY updated_at ASC for pending actions (oldest first = fairness)
  - Use ORDER BY date_received DESC for message lists (newest first = user expectation)
  - Initialize counts dictionary with 0 values to handle missing status groups
---

## 2026-01-15 09:30 - US-003
- **What was implemented**: Filter initial sync to INBOX messages only
- **Files changed**:
  - Sources/SwiftEAKit/Modules/MailModule/MailSync.swift (added MailboxType enum, classifyMailbox function, updated queryMessages)
  - Tests/SwiftEAKitTests/MailSyncTests.swift (added 10 new tests)
- **Implementation details**:
  - Added MailboxType enum with cases: inbox, archive, trash, sent, drafts, junk, other
  - Added classifyMailbox(url:name:) function that classifies mailboxes from URL or name
  - Classification is case-insensitive (e.g., "INBOX", "inbox", "Inbox" all return .inbox)
  - Updated queryMessages() to INNER JOIN with mailboxes table and filter WHERE LOWER(mb.url) LIKE '%/inbox'
  - New synced messages get mailbox_status = 'inbox' by default (MailMessage init default)
- **Tests added**: 10 new tests for MailboxType enum values and classifyMailbox function
- **Learnings for future iterations**:
  - Apple Mail URLs end with the mailbox name (e.g., "mailbox://account/INBOX")
  - Use LOWER() in SQL for case-insensitive matching
  - Use INNER JOIN (not LEFT JOIN) when filtering to only include rows with matches
---

## 2026-01-15 09:35 - US-004
- **What was implemented**: Detect mailbox moves in Apple Mail (forward sync)
- **Files changed**:
  - Sources/SwiftEAKit/Modules/MailModule/MailSync.swift (added detectMailboxMoves() function, integrated into incremental sync)
  - Sources/SwiftEAKit/Modules/MailModule/MailDatabase.swift (updated getTrackedInboxMessages() to track all statuses)
  - Tests/SwiftEAKitTests/MailSyncTests.swift (added 12 new tests for mailbox move detection)
- **Implementation details**:
  - Added public detectMailboxMoves() function to MailSync class
  - Function queries Apple Mail database for current mailbox of all tracked messages
  - Uses classifyMailbox() to determine mailbox type (inbox, archive, trash, etc.)
  - Updates mailbox_status based on detected moves:
    - Messages in Archive folder → status = 'archived'
    - Messages in Trash folder → status = 'deleted'
    - Messages in INBOX → status = 'inbox' (Apple Mail wins - allows move-back)
  - Batched queries (500 messages per batch) for performance
  - Integrated into performIncrementalSync() as Phase 3 (before deletion detection)
  - Returns count of status changes
- **getTrackedInboxMessages() update**:
  - Changed from only returning inbox messages to returning ALL non-soft-deleted messages
  - This enables detection when archived/deleted messages move back to INBOX
- **Tests added**: 12 new tests covering:
  - getTrackedInboxMessages includes all statuses (inbox, archived, deleted)
  - getTrackedInboxMessages excludes soft-deleted messages
  - TrackedMessageInfo contains correct data
  - updateMailboxStatus works for inbox→archived, archived→inbox, inbox→deleted transitions
- **Learnings for future iterations**:
  - getTrackedInboxMessages must return ALL messages (not just inbox) to detect move-back scenarios
  - Apple Mail is the source of truth for forward sync - always update local status to match
  - Use batch size of 500 for efficient Apple Mail DB queries
  - NULL vs 0 in database: appleRowId=nil is stored as 0, not NULL, so queries should use IS NOT NULL
---
