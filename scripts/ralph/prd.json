{
  "project": "SwiftEA",
  "branchName": "ralph/bidirectional-inbox-mail-sync",
  "description": "Bidirectional INBOX-Only Mail Sync - Track message states and sync archive/delete actions between SwiftEA and Apple Mail",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add mailbox status tracking columns to schema",
      "description": "As a developer, I need to store message mailbox status and pending sync actions in the database.",
      "acceptanceCriteria": [
        "Add mailbox_status column (TEXT, default 'inbox') to messages table",
        "Add pending_sync_action column (TEXT, nullable) to messages table",
        "Add last_known_mailbox_id column (INTEGER, nullable) to messages table",
        "Define MailboxStatus enum with cases: inbox, archived, deleted",
        "Define SyncAction enum with cases: archive, delete",
        "Update MailMessage struct with mailboxStatus, pendingSyncAction, lastKnownMailboxId properties",
        "Existing messages get mailbox_status = 'inbox' after migration",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 1,
      "passes": true,
      "notes": "File: Sources/SwiftEAKit/Modules/MailModule/MailDatabase.swift (~line 50-100)"
    },
    {
      "id": "US-002",
      "title": "Add database methods for status queries and updates",
      "description": "As a developer, I need methods to query and update mailbox status and pending sync actions.",
      "acceptanceCriteria": [
        "Add updateMailboxStatus(id:status:) method that updates mailbox_status column",
        "Add setPendingSyncAction(id:action:) method that sets pending_sync_action",
        "Add clearPendingSyncAction(id:) method that clears pending_sync_action to nil",
        "Add getMessagesWithPendingActions() method returning messages with non-null pending_sync_action",
        "Add getMessagesByStatus(_:) method filtering by mailbox_status",
        "Add getMessageCountByStatus() method returning counts for each status",
        "All methods handle missing message IDs gracefully",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 2,
      "passes": true,
      "notes": "File: Sources/SwiftEAKit/Modules/MailModule/MailDatabase.swift (~line 300-400)"
    },
    {
      "id": "US-003",
      "title": "Filter initial sync to INBOX messages only",
      "description": "As a user, I want only INBOX messages synced so my vault isn't cluttered with sent/trash/junk.",
      "acceptanceCriteria": [
        "Define MailboxType enum with cases: inbox, archive, trash, sent, drafts, junk, other",
        "Add classifyMailbox(url:name:) function that identifies mailbox type from URL/name",
        "classifyMailbox returns .inbox for 'INBOX' (case-insensitive)",
        "classifyMailbox returns .archive for 'Archive' or 'All Mail'",
        "classifyMailbox returns .trash for 'Trash' or 'Deleted'",
        "Sync query filters to only fetch messages where mailbox classifies as .inbox",
        "New synced messages have mailbox_status = 'inbox'",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 3,
      "passes": false,
      "notes": "File: Sources/SwiftEAKit/Modules/MailModule/MailSync.swift (~line 150-200)"
    },
    {
      "id": "US-004",
      "title": "Detect mailbox moves in Apple Mail (forward sync)",
      "description": "As a user, I want SwiftEA to detect when I archive or delete messages in Apple Mail.",
      "acceptanceCriteria": [
        "Add detectMailboxMoves() function to MailSync",
        "Function queries Apple Mail for current mailbox of tracked inbox messages",
        "Messages moved to Archive folder get mailbox_status = 'archived'",
        "Messages moved to Trash folder get mailbox_status = 'deleted'",
        "Messages moved back to INBOX get mailbox_status = 'inbox' (Apple Mail wins)",
        "Function returns count of status changes",
        "Incremental sync calls detectMailboxMoves() automatically",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 4,
      "passes": false,
      "notes": "File: Sources/SwiftEAKit/Modules/MailModule/MailSync.swift (~line 200-250)"
    },
    {
      "id": "US-005",
      "title": "Push archive/delete actions to Apple Mail (backward sync)",
      "description": "As a user, I want to archive or delete messages from SwiftEA CLI and have them move in Apple Mail.",
      "acceptanceCriteria": [
        "Create new file MailSyncBackward.swift",
        "Define MailSyncBackward class with mailDatabase dependency",
        "Add archiveMessage(id:) method using optimistic update pattern",
        "Add deleteMessage(id:) method using optimistic update pattern",
        "Optimistic pattern: update local DB → execute AppleScript → rollback on failure",
        "Add processPendingActions() method that processes all queued actions",
        "Define BackwardSyncResult struct with archived, deleted, failed counts",
        "AppleScript moves message to Archive mailbox for archive action",
        "AppleScript moves message to Trash mailbox for delete action",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 5,
      "passes": false,
      "notes": "New file: Sources/SwiftEAKit/Modules/MailModule/MailSyncBackward.swift"
    },
    {
      "id": "US-006",
      "title": "Update daemon to 60-second interval with backward sync",
      "description": "As a user, I want continuous bidirectional sync every 60 seconds.",
      "acceptanceCriteria": [
        "Change default sync interval from 300s to 60s",
        "Daemon loop calls forward sync (existing behavior)",
        "Daemon loop calls backwardSync.processPendingActions() after forward sync",
        "Backward sync results logged (archived count, deleted count)",
        "Failed backward sync actions logged as warnings",
        "Manual 'swea mail sync' command also triggers backward sync",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 6,
      "passes": false,
      "notes": "File: Sources/SwiftEACLI/Commands/MailCommand.swift (~line 50-100)"
    },
    {
      "id": "US-007",
      "title": "Update CLI archive/delete commands to use backward sync",
      "description": "As a user, I want swea mail archive and delete commands to sync to Apple Mail.",
      "acceptanceCriteria": [
        "MailArchiveCommand uses MailSyncBackward.archiveMessage()",
        "MailDeleteCommand uses MailSyncBackward.deleteMessage()",
        "Add --status option to search command (inbox, archived, deleted)",
        "swea mail search --status inbox filters to inbox messages only",
        "swea mail search --status archived filters to archived messages only",
        "swea mail search --status deleted filters to deleted messages only",
        "Invalid status values produce helpful error message",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 7,
      "passes": false,
      "notes": "File: Sources/SwiftEACLI/Commands/MailCommand.swift (~line 200-300)"
    },
    {
      "id": "US-008",
      "title": "Add automated test suite for bidirectional sync",
      "description": "As a developer, I need tests to verify all bidirectional sync functionality.",
      "acceptanceCriteria": [
        "Test migration V2 creates mailbox_status column with default 'inbox'",
        "Test migration V2 creates pending_sync_action and last_known_mailbox_id columns",
        "Test classifyMailbox returns correct types for INBOX, Archive, Trash, Sent, Junk",
        "Test classifyMailbox is case-insensitive",
        "Test updateMailboxStatus updates status correctly",
        "Test getMessagesByStatus filters correctly",
        "Test getMessagesWithPendingActions returns correct messages",
        "Test optimistic update sets status before AppleScript (mock AppleScript)",
        "Test failed AppleScript rolls back to original state",
        "Typecheck passes",
        "Tests pass"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Files: Tests/SwiftEAKitTests/MailSyncTests.swift, Tests/SwiftEAKitTests/MailSyncBackwardTests.swift (new), Tests/SwiftEAKitTests/MailDatabaseTests.swift"
    }
  ]
}
